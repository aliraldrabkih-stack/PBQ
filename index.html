<!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Security+ PBQ — Lesson 1</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
:root[data-theme="dark"] {
  --bg:#0b0b0d; --card:#121217; --soft:#171821; --stroke:#2a2b36;
  --text:#f5f5f7; --text-dim:#b8b8c6; --accent:#ff6a00;
  --tile:#1b1d28; --tile-border:#2a2b36;
  --ok:#22c55e; --bad:#ef4444; --green:#34d399;
}
:root[data-theme="light"] {
  --bg:#f7f8fb; --card:#ffffff; --soft:#f1f3f7; --stroke:#cfd6e0;
  --text:#101418; --text-dim:#585f6b; --accent:#ff6a00;
  --tile:#ffffff; --tile-border:#e6ebf2;
  --ok:#22c55e; --bad:#ef4444; --green:#078b62;
}

/* Logo filter tweaks per theme */
header img.logo { max-height:44px; width:auto; transition:filter .2s ease, opacity .2s ease; }
:root[data-theme="dark"] header img.logo { filter: brightness(1.08) contrast(1.06); }
:root[data-theme="light"] header img.logo { filter: none; }

*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:1200px;margin:0 auto;padding:20px}
header{display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap}
h1{margin:0;color:var(--accent);font-size:20px}
.grow{flex:1}
.btn{border:1px solid var(--stroke);background:transparent;color:var(--text);padding:8px 14px;border-radius:12px;cursor:pointer}
.btn--primary{background:var(--accent);color:#111;border-color:var(--accent);font-weight:700}
.btnrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.board{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:16px}
.toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
.crumbs{display:flex;gap:6px;flex-wrap:wrap}
.crumb{display:inline-flex;align-items:center;justify-content:center;min-width:36px;height:32px;padding:0 10px;background:var(--soft);border:1px solid var(--stroke);border-radius:10px;color:var(--text-dim);cursor:pointer}
.crumb.active{background:var(--accent);color:#111;border-color:var(--accent)}
.crumb.flagged::after{content:'🚩';margin-left:4px}
.card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:14px;margin-bottom:12px}
.title{color:var(--accent);margin-bottom:4px}
.hint{color:var(--text-dim);font-size:13px;margin-bottom:8px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
.choices{display:grid;gap:10px}
.choice{border:1px solid var(--stroke);background:var(--soft);padding:10px;border-radius:10px;cursor:pointer}
.choice[aria-checked="true"]{outline:2px solid var(--accent)}
.dropzone{min-height:80px;border:1px dashed var(--tile-border);border-radius:10px;padding:8px;margin-bottom:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:center}
.tile{background:var(--tile);padding:8px 10px;border-radius:8px;border:1px solid var(--stroke);display:inline-block;cursor:grab;font-size:16px;touch-action:none}
.list{display:flex;flex-direction:column;gap:8px}
.row{display:grid;grid-template-columns:200px 1fr;gap:10px;align-items:start}
.table{width:100%;border-collapse:separate;border-spacing:8px}
.cell{min-height:70px;border:1px dashed var(--tile-border);border-radius:10px;padding:8px}
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:10px;flex-wrap:wrap}
#toast{position:fixed;right:20px;bottom:20px;background:var(--card);border:1px solid var(--stroke);padding:10px 14px;border-radius:10px;display:none;z-index:9999}

/* Report + Certificate */
#nameGate{display:none;background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:20px;max-width:520px;width:92%;margin:16px auto}
#reportWrap{display:none;margin-top:14px}
.report{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:16px}
.report h3{margin:0 0 10px;color:#111;background:var(--accent);display:inline-block;padding:6px 10px;border-radius:10px}
.report .summary{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #b85100;background:linear-gradient(180deg, rgba(255,106,0,.20), rgba(255,106,0,.08));color:#ffe3d1}
.badge.ok{background:rgba(34,197,94,.18);border-color:#1f6a40;color:#c9f0d9}
.badge.bad{background:rgba(239,68,68,.18);border-color:#7a2929;color:#ffd2d2}
.tableR{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
.tableR thead th{background:rgba(255,106,0,.18);color:#fff;border-bottom:1px solid #b85100;padding:10px;text-align:left}
.tableR td{padding:10px;border-bottom:1px solid var(--stroke);text-align:left;color:var(--text)}
.tableR tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}
.tableR tbody tr:hover{background:rgba(255,106,0,.10)}
.result-pill{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700}
.result-ok{background:rgba(34,197,94,.18);color:#9de3b8;border:1px solid #1f6a40}
.result-bad{background:rgba(239,68,68,.18);color:#ffc3c3;border:1px solid #7a2929}
.result-mid{background:rgba(255,106,0,.20);color:#ffd3bf;border:1px solid #b85100}

/* Light-mode overrides for Report (fix white text) */
:root[data-theme="light"] .tableR thead th {
  background:rgba(255,106,0,.12);
  color:#101418;
  border-bottom:1px solid #b85100;
}
:root[data-theme="light"] .tableR tbody tr:nth-child(odd){ background:rgba(0,0,0,.02) }
:root[data-theme="light"] .tableR tbody tr:hover{ background:rgba(255,106,0,.06) }

:root[data-theme="light"] .badge {
  border-color:#b85100;
  background:linear-gradient(180deg, rgba(255,106,0,.12), rgba(255,106,0,.06));
  color:#6b3f00;
}
:root[data-theme="light"] .badge.ok { background:rgba(34,197,94,.12); border-color:#1f6a40; color:#1f6a40 }
:root[data-theme="light"] .badge.bad{ background:rgba(239,68,68,.12); border-color:#7a2929; color:#7a2929 }
:root[data-theme="light"] .result-ok { background:rgba(34,197,94,.12); color:#1f6a40; border:1px solid #1f6a40 }
:root[data-theme="light"] .result-bad{ background:rgba(239,68,68,.12); color:#7a2929; border:1px solid #7a2929 }
:root[data-theme="light"] .result-mid{ background:rgba(255,106,0,.12); color:#6b3f00; border:1px solid #b85100 }

#certWrap{display:none;margin-top:12px}
#cert{
  background:radial-gradient(1200px 600px at -10% -20%, rgba(255,106,0,.25), transparent 50%),
             linear-gradient(135deg,#0a0a0a 0%,#0b0c0f 60%,#111 100%);
  color:#fff;border-radius:28px;padding:40px;max-width:1100px;margin:auto;
  box-shadow:0 12px 60px rgba(0,0,0,.45);border:1px solid #1f1f1f
}
#cert .hdr{display:flex;align-items:flex-start;justify-content:space-between;gap:24px;flex-wrap:wrap}
.brand{display:flex;flex-direction:column;gap:8px;min-width:320px}
.brand .line1{font-weight:900;letter-spacing:6px}
.brand .line1 .cyber{color:var(--accent)}
.brand .line1 .academy{color:#f5f5f7}
.brand .sub{font-size:13px;color:#bdbdc7}
.brand .stack{line-height:0.95;font-weight:900;text-transform:uppercase;color:var(--accent);
  text-shadow:0 0 18px rgba(255,106,0,.28), 0 0 4px rgba(255,106,0,.65);}
.brand .stack .small{font-size:36px}
#cert .seal{width:0;height:0}
#cert .line{height:2px;background:#222;margin:22px 0}
#cert h2{margin:10px 0 0;font-size:36px}
#cert .muted{color:#cfd2da}
#cert .meta{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-top:14px}
#cert .laurel{font-size:16px;color:var(--green);font-weight:800}
#cert .scoreBadge{display:inline-block;padding:10px 14px;border:1px solid var(--accent);border-radius:12px;color:var(--accent);font-weight:800;background:rgba(255,106,0,.10)}
@media (max-width:768px){
  .crumb{min-width:32px;height:30px}
  .btnrow{flex-wrap:wrap}
}
@media print{
  body{-webkit-print-color-adjust:exact;print-color-adjust:exact;background:#fff}
  #cert{box-shadow:none;border:1px solid #ddd}
}

/* === Hotspot styles === */
.hotimg{position:relative;max-width:1200px;margin:0 auto 10px}
.hotimg img{width:100%;height:auto;border-radius:12px;border:1px solid var(--stroke)}
.hotspot{position:absolute;width:28px;height:28px;border-radius:50%;background:var(--accent);color:#111;
  display:flex;align-items:center;justify-content:center;font-weight:800;cursor:pointer;
  border:2px solid rgba(17,17,17,.25);box-shadow:0 4px 14px rgba(0,0,0,.35)}
.hotspot.answered{background:linear-gradient(180deg, rgba(255,106,0,.86), rgba(255,106,0,.66));}
.hotpop{position:absolute;background:var(--card);border:1px solid var(--stroke);border-radius:10px;padding:10px;
  z-index:50;display:none;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.35)}
.hotopt{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.hotopt .btn{padding:6px 10px;border-radius:10px}
.hotopt .btn[data-val]{border-color:var(--tile-border);}
.hot-legend{color:var(--text-dim);font-size:13px;margin:6px 0 0}

/* Labels near each hotspot */
.hotlabel{
  position:absolute;
  padding:4px 8px;
  border-radius:10px;
  border:1px solid var(--stroke);
  background:rgba(0,0,0,.45);
  color:#fff;
  font-size:13px;
  white-space:nowrap;
  transform:translate(18px,-10px);
  pointer-events:none;
  text-shadow:0 1px 1px rgba(0,0,0,.35);
}
:root[data-theme="light"] .hotlabel{
  background:rgba(255,255,255,.85);
  color:#101418;
  text-shadow:none;
}

/* === Pyramid list styling for Q3 (restored) === */
.list.pyramid-list{
  gap:12px;
  align-items:center;
  padding:6px 0;
}
.list.pyramid-list .tile{
  width:var(--w,70%);
  text-align:center;
  font-weight:700;
  letter-spacing:.2px;
  background:linear-gradient(180deg, rgba(255,106,0,.18), rgba(255,106,0,.08));
  border:1px solid #b85100;
  color:var(--text);
  clip-path:polygon(6% 0, 94% 0, 100% 100%, 0 100%);
}
:root[data-theme="light"] .list.pyramid-list .tile{
  background:linear-gradient(180deg, rgba(255,106,0,.12), rgba(255,106,0,.05));
  color:#101418;
}
.list.pyramid-list .tile:nth-child(1){ --w:42%; }
.list.pyramid-list .tile:nth-child(2){ --w:58%; }
.list.pyramid-list .tile:nth-child(3){ --w:76%; }
.list.pyramid-list .tile:nth-child(4){ --w:92%; }

/* === Simple Warning Overlay (no detection, English) === */
#warnGate{
  position:fixed; inset:0;
  background:linear-gradient(135deg, rgba(255,106,0,.08), transparent 60%), var(--bg);
  display:none; align-items:center; justify-content:center;
  z-index:99999; padding:24px;
}
#warnGate .panel{
  background:var(--card); border:1px solid var(--stroke);
  border-radius:16px; max-width:720px; width:100%; padding:24px;
  text-align:center; box-shadow:0 18px 60px rgba(0,0,0,.45);
}
#warnGate h2{ margin:0 0 8px; color:var(--accent); }
#warnGate p{ color:var(--text-dim); margin:6px 0 0; }
#warnGate .btnrow{ display:flex; gap:8px; justify-content:center; margin-top:16px; }
#warnGate .btnrow .btn{ padding:10px 14px; border-radius:12px; }
</style>
</head>
<body>
<div class="container">
  <header>
    <img id="brandLogo" src="https://cdn.durable.co/logos/10jUW6H5kMws6XP3Klr5QlXg6xDZZVGCvWIAeZvGSSa9C7BAhrPp5oxANMifgiKX.png" alt="Logo" class="logo">
    <h1 class="grow">Security+ PBQ — Lesson 1</h1>
    <button id="themeBtn" class="btn">🌓 Theme</button>
  </header>

  <div class="board" role="region" aria-label="Exercise Board">
    <div class="toolbar">
      <div class="crumbs" id="crumbs" role="tablist" aria-label="Questions Navigation"></div>
      <div class="btnrow">
        <button class="btn" id="prev">⟨ Prev</button>
        <button class="btn" id="next">Next ⟩</button>
        <button class="btn" id="flagBtn">Flag</button>
        <button class="btn btn--primary" id="finishBtn">Finish Exam</button>
        <button class="btn" id="resetAll">Reset</button>
      </div>
    </div>
    <div id="stage" aria-live="polite"></div>
  </div>

  <div id="reportWrap" class="report" role="region" aria-label="Exam Report">
    <h3>Exam Report</h3>
    <div class="summary">
      <span class="badge" id="repTotal">Questions: 0</span>
      <span class="badge ok" id="repCorrect">Correct: 0</span>
      <span class="badge bad" id="repWrong">Wrong: 0</span>
      <span class="badge" id="repScore">Score: 0%</span>
    </div>
    <table class="tableR" id="repTable">
      <thead><tr><th>#</th><th>Question</th><th>Type</th><th>Result</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="nameGate" role="region" aria-label="Name Gate" style="display:none">
    <div class="card">
      <label for="studentName">Enter your full name to generate your certificate:</label>
      <div class="btnrow" style="margin-top:8px">
        <input id="studentName" placeholder="Your name" style="padding:8px;border-radius:8px;border:1px solid var(--stroke);background:var(--soft);color:var(--text);min-width:260px"/>
        <button id="buildCert" class="btn btn--primary">Generate Certificate</button>
        <button id="closeGate" class="btn">Close</button>
      </div>
    </div>
  </div>

  <div id="certWrap" style="display:none">
    <div id="cert" role="region" aria-label="Certificate Preview">
      <div class="hdr">
        <div class="brand">
          <div class="line1"><span class="cyber">CYBER</span> <span class="academy">ACADEMY</span></div>
          <div class="sub">Coaching & Mentoring</div>
          <div class="stack">
            <div class="small">CERTIFICATE</div>
            <div class="small">OF ACHIEVEMENT</div>
          </div>
        </div>
        <div class="seal"></div>
      </div>
      <div class="line"></div>
      <h2 id="certName">Student Name</h2>
      <p class="muted">has successfully completed the CompTIA Security+ lesson one PBQ.</p>
      <div class="meta">
        <div class="laurel">Awarded on <span id="certDate"></span></div>
        <div class="scoreBadge" id="certScore">Score: 0% • <span id="passFlag">FAIL</span></div>
      </div>
      <div class="line"></div>
      <p class="muted" style="opacity:.9">This certificate reflects your overall result. It is honorary and not an official score report.</p>
    </div>
    <div class="btnrow" style="justify-content:center; margin-top:12px">
      <button id="printCert" class="btn btn--primary">Save PNG</button>
      <button id="closeCert" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- Warning-only overlay (English, no detection) -->
<div id="warnGate" role="dialog" aria-modal="true" aria-label="Best on Desktop">
  <div class="panel">
    <h2>Best Experience on Desktop</h2>
    <p>This PBQ uses drag-and-drop and wide layouts. It may be harder to use on phones or small screens.</p>
    <div class="btnrow">
      <button id="warnContinue" class="btn btn--primary">Continue</button>
      <button id="warnHideForever" class="btn">Don't show again</button>
    </div>
  </div>
</div>

<div id="toast" role="status" aria-live="polite"></div>

<script>
const $=q=>document.querySelector(q),el=(t,c,txt)=>{const e=document.createElement(t);if(c)e.className=c;if(txt!==undefined)e.textContent=txt;return e}
function shuffle(a){return a.map(x=>[Math.random(),x]).sort((a,b)=>a[0]-b[0]).map(x=>x[1])}
function toast(m,ms=1800){const t=$("#toast");t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',ms)}
function todayStr(){return new Date().toLocaleDateString()}
let index=0,lastPct=0,lastGot=0,lastTotal=0,lastPerQ=[]
const state={},meta={}
let selectedTile=null;

// THEME assets (fix logo swap)
const LOGO_DARK  = "https://cdn.durable.co/logos/10jUW6H5kMws6XP3Klr5QlXg6xDZZVGCvWIAeZvGSSa9C7BAhrPp5oxANMifgiKX.png";
const LOGO_LIGHT = "https://github.com/aliraldrabkih-stack/ali32erkl/blob/main/image-removebg-preview(8)(1).png?raw=true";
function applyThemeAssets(){
  const theme = document.documentElement.getAttribute('data-theme') || 'dark';
  const logo = document.getElementById('brandLogo');
  if(!logo) return;
  logo.src = theme === 'light' ? LOGO_LIGHT : LOGO_DARK;
}

// ====== Questions bank (English) ======
const bank=[
 {id:'cia',tag:'Basics',title:'CIA Triad Classification',hint:'Drag each scenario to the correct CIA component.',type:'drag-classify',
  zones:[{id:'c',title:'Confidentiality'},{id:'i',title:'Integrity'},{id:'a',title:'Availability'}],
  items:[
    {id:'cia1',text:'Credential theft / identity spoofing',zone:'c'},
    {id:'cia2',text:'Unauthorized modification of transaction records',zone:'i'},
    {id:'cia3',text:'Service outage due to DDoS',zone:'a'}
  ]},

 {id:'ir',tag:'IR',title:'Incident Response – Correct Order',hint:'Arrange the steps top→bottom.',type:'order',
  items:[
    {id:'ir1',text:'Preparation',order:1},
    {id:'ir2',text:'Identification',order:2},
    {id:'ir3',text:'Containment',order:3},
    {id:'ir4',text:'Eradication',order:4},
    {id:'ir5',text:'Recovery',order:5},
    {id:'ir6',text:'Lessons Learned',order:6}
  ]},

 {id:'staff',tag:'IR',title:'Security Staff Escalation Order (Pyramid)',hint:'Arrange roles from TOP (apex) to BOTTOM (base).',type:'order',
  items:[
    {id:'st4',text:'CISO',order:1},
    {id:'st3',text:'Incident Response Manager',order:2},
    {id:'st1',text:'Security Engineer (Tier 2)',order:3},
    {id:'st2',text:'Security Analyst (Tier 1)',order:4}
  ]},

 {id:'se1',tag:'SOCIAL',title:'Social Engineering',hint:'Select the best answer.',type:'single',
  question:'A caller pretends to be the CEO and pressures the helpdesk to reset a password. What attack is this?',
  choices:[
    {id:'s1',text:'Email Phishing'},
    {id:'s2',text:'Vishing with Pretexting',correct:true},
    {id:'s3',text:'Smishing'},
    {id:'s4',text:'Pharming'}
  ]},

 {id:'msg',tag:'SOCIAL',title:'Message-based Threat Vectors (Select ALL)',hint:'Multiple correct answers.',type:'multi',
  question:'Which of the following are message-based threat vectors?',
  choices:[
    {id:'m1',text:'Email',correct:true},
    {id:'m2',text:'SMS',correct:true},
    {id:'m3',text:'Instant Messaging (IM)',correct:true},
    {id:'m4',text:'USB drop attack'},
    {id:'m5',text:'Open TCP service port'}
  ]},

 {id:'match1',tag:'Controls',title:'Match Controls to Categories',hint:'Drag each control to its category.',type:'match',
  right:[
    {id:'mgr',title:'Managerial'},
    {id:'opr',title:'Operational'},
    {id:'tec',title:'Technical'},
    {id:'phy',title:'Physical'}
  ],
  left:[
    {id:'ml1',text:'Information security policies',target:'mgr'},
    {id:'ml2',text:'Security awareness training',target:'opr'},
    {id:'ml3',text:'Firewall rule',target:'tec'},
    {id:'ml4',text:'IDS alert',target:'tec'},
    {id:'ml5',text:'Security guard at data center',target:'phy'}
  ]},

 {id:'match2',tag:'Network',title:'Match Protocols to Their Port Numbers',hint:'Drag each protocol to its correct port.',type:'match',
  right:[
    {id:'p21', title:'Port 21'},
    {id:'p22', title:'Port 22'},
    {id:'p25', title:'Port 25'},
    {id:'p443', title:'Port 443'}
  ],
  left:[
    {id:'ftp', text:'FTP', target:'p21'},
    {id:'ssh', text:'SSH', target:'p22'},
    {id:'smtp', text:'SMTP', target:'p25'},
    {id:'https', text:'HTTPS', target:'p443'}
  ]
 },

 {id:'table1',tag:'Networking',title:'Place Services Under the Right Transport',hint:'Drag each service to the correct cell.',type:'table',
  columns:[{id:'tcp',title:'TCP'},{id:'udp',title:'UDP'}],rows:[{id:'srv',title:'Service'}],
  items:[
    {id:'t80',text:'HTTP (80)',cell:'tcp'},
    {id:'t443',text:'HTTPS (443)',cell:'tcp'},
    {id:'u53',text:'DNS queries (53)',cell:'udp'},
    {id:'u161',text:'SNMP (161)',cell:'udp'}
  ]},

 {id:'phish',tag:'SOCIAL',title:'Phishing Combinations',hint:'For each row, combine a method and the matching result.',type:'phishRows',
  icons:[
    {id:'i_sms',html:'<div class="emoji">📱</div><div>SMS</div>',value:'sms'},
    {id:'i_dns',html:'<div class="emoji">🌐</div><div>DNS</div>',value:'dns'},
    {id:'i_voice',html:'<div class="emoji">📞</div><div>Voice</div>',value:'voice'}
  ],
  results:[
    {id:'r_smish',text:'Smishing',value:'sms'},
    {id:'r_pharm',text:'Pharming',value:'dns'},
    {id:'r_vish',text:'Vishing',value:'voice'}
  ]},

 {id:'mfa_factors',tag:'IAM',title:'MFA Factors Classification',hint:'Drag each item to the right factor.',type:'drag-classify',
  zones:[
    {id:'know',title:'Knowledge (something you know)'},
    {id:'have',title:'Possession (something you have)'},
    {id:'are',title:'Inherence (something you are)'},
    {id:'loc',title:'Location'}
  ],
  items:[
    {id:'it1',text:'Password / PIN',zone:'know'},
    {id:'it2',text:'Smart card / Security key',zone:'have'},
    {id:'it3',text:'Fingerprint scan',zone:'are'},
    {id:'it4',text:'Login from known corporate IP / Geofence',zone:'loc'}
  ]},

 {id:'pw_best',tag:'IAM',title:'Password Best Practices (Select ALL)',hint:'Multiple correct answers.',type:'multi',
  question:'Which of the following are recommended password practices?',
  choices:[
    {id:'p1',text:'Use a unique password per site',correct:true},
    {id:'p2',text:'Use a reputable password manager',correct:true},
    {id:'p3',text:'Rotate passwords every 30 days regardless',correct:false},
    {id:'p4',text:'Prefer long passphrases over short complexity',correct:true}
  ]},

 {id:'auth_flow',tag:'IAM',title:'Authentication Lifecycle Order',hint:'Arrange initial identity lifecycle (top→bottom).',type:'order',
  items:[
    {id:'a1',text:'Enrollment (collect attributes)',order:1},
    {id:'a2',text:'Provisioning (issue creds & perms)',order:2},
    {id:'a3',text:'Authentication (verify identity)',order:3},
    {id:'a4',text:'Authorization (access rights)',order:4},
    {id:'a5',text:'Accounting / Auditing (logs)',order:5}
  ]},

 {id:'tf1',tag:'IAM',title:'True/False',hint:'Choose True or False.',type:'single',
  question:'Kerberos uses tickets to delegate access between services.',
  choices:[{id:'tf1a',text:'True',correct:true},{id:'tf1b',text:'False'}]},

 {id:'tf2',tag:'IAM',title:'True/False',hint:'Choose True or False.',type:'single',
  question:'SMS-based MFA is completely secure and cannot be intercepted.',
  choices:[{id:'tf2a',text:'True',correct:false},{id:'tf2b',text:'False',correct:true}]},

 {id:'tf3',tag:'Access',title:'True/False',hint:'Choose True or False.',type:'single',
  question:'Least privilege means giving minimum permissions needed.',
  choices:[{id:'tf3a',text:'True',correct:true},{id:'tf3b',text:'False'}]},

 /* === Hotspot (English labels) === */
 {id:'hotmap1', tag:'Controls', title:'Identify Controls on the Company Floor Plan', hint:'Click each marker and choose the best control category.', type:'hotspot',
  image:'https://raw.githubusercontent.com/aliraldrabkih-stack/pbq/refs/heads/main/ChatGPT%20Image%20Oct%204%2C%202025%2C%2009_24_44%20PM.png',
  spots:[
    {id:'s1', x:91, y:58, correct:'physical',   note:'Entrance door with keypad', label:'Entrance Door'},
    {id:'s2', x:66, y:20, correct:'technical',  note:'Server racks',               label:'Server'},
    {id:'s3', x:79, y:28, correct:'technical',  note:'Security appliance / firewall', label:'Firewall'},
    {id:'s4', x:13, y:72, correct:'operational',note:'Training room with presentation', label:'Training Room'},
    {id:'s5', x:30, y:20, correct:'managerial', note:'Manager office reviewing policies', label:"Manager's Office"},
    {id:'s6', x:7,  y:10, correct:'physical',   note:'CCTV corner coverage',       label:'CCTV Camera'}
  ]
 }
];

function scoreQuestion(q,st){
 let got=0,total=0;
 if(q.type==='drag-classify'){
   total+=q.items.length;
   q.items.forEach(it=>{ if(st.placed && st.placed[it.id]===it.zone) got++; });
 }
 else if(q.type==='order'){
   total+=q.items.length;
   const seq=(st.order||[]);
   const right=[...(q.items||[])].sort((a,b)=>a.order-b.order).map(x=>x.id);
   right.forEach((id,idx)=>{ if(seq[idx]===id) got++; });
 }
 else if(q.type==='single'){
   total+=1;
   const right=(q.choices||[]).find(x=>x.correct);
   if(st.answer===right?.id) got++;
 }
 else if(q.type==='multi'){
   const correct=(q.choices||[]).filter(x=>x.correct).map(x=>x.id);
   total+=correct.length;
   (st.answers||[]).forEach(id=>{ if(correct.includes(id)) got++; });
 }
 else if(q.type==='match'){
   const lefts=q.left||[];
   total+=lefts.length;
   lefts.forEach(i=>{ if(st.map && st.map[i.id]===i.target) got++; });
 }
 else if(q.type==='table'){
   total+=q.items.length;
   q.items.forEach(i=>{ if(st.cells && st.cells[i.id]===i.cell) got++; });
 }
 else if(q.type==='phishRows'){
   total+=3;
   for(let r=1;r<=3;r++){
     const lhs = st['plus'+r+'_obj']?.value;
     const rhs = st['eq'+r+'_obj']?.value;
     if(lhs && rhs && lhs===rhs) got++;
   }
 }
 else if(q.type==='hotspot'){
   const sel=(st.sel||{});
   total += (q.spots||[]).length;
   (q.spots||[]).forEach(sp=>{ if(sel[sp.id] && sel[sp.id]===sp.correct) got++; });
 }
 return {got,total}
}
function scoreAll(){
 let got=0,total=0;lastPerQ=[]
 bank.forEach((q,i)=>{const st=state[q.id]||{};const r=scoreQuestion(q,st);lastPerQ.push({idx:i+1,id:q.id,title:q.title,type:q.type,got:r.got,total:r.total});got+=r.got;total+=r.total})
 return {got,total}
}
function buildReport(){
 const tbody=$("#repTable tbody");tbody.innerHTML=''
 lastPerQ.forEach(r=>{
  let label,cls;
  if(r.total===0){label='—';cls='result-mid'}
  else if(r.got===r.total){label='Correct';cls='result-ok'}
  else if(r.got===0){label='Wrong';cls='result-bad'}
  else {label=`${r.got}/${r.total}`;cls='result-mid'}
  const tr=document.createElement('tr')
  tr.innerHTML=`<td>${r.idx}</td><td>${r.title}</td><td>${r.type}</td><td><span class="result-pill ${cls}">${label}</span></td>`
  tbody.append(tr)
 })
 $("#repTotal").textContent=`Questions: ${bank.length}`
 $("#repCorrect").textContent=`Correct: ${lastPerQ.filter(r=>r.total>0&&r.got===r.total).length}`
 $("#repWrong").textContent=`Wrong: ${lastPerQ.filter(r=>r.total>0&&r.got<r.total).length}`
 $("#repScore").textContent=`Score: ${lastPct}%`
 $("#reportWrap").style.display='block'
}

function renderCrumbs(){
 const wrap=$("#crumbs");wrap.innerHTML=''
 bank.forEach((q,i)=>{
  const c=el('button','crumb','Q'+(i+1));
  c.setAttribute('role','tab');
  c.setAttribute('aria-selected',i===index?'true':'false');
  c.setAttribute('aria-label',`Question ${i+1}${meta[q.id]?.flagged ? ', flagged for review' : ''}`);
  if(i===index)c.classList.add('active');
  if(meta[q.id]?.flagged)c.classList.add('flagged');
  c.onclick=()=>{index=i;mount()};
  wrap.append(c)
 })
}
function tile(it){const t=document.createElement('div');t.className='tile';t.draggable=true;t.dataset.id=it.id;if(it.html)t.innerHTML=it.html;else t.textContent=it.text||it.id;if(it.value)t.dataset.value=it.value;return t}
function orderTile(it){return tile(it)}

function toggleFlag(){
 const q=bank[index];meta[q.id]=meta[q.id]||{flagged:false};
 meta[q.id].flagged=!meta[q.id].flagged;
 $("#flagBtn").textContent=meta[q.id].flagged?'Unflag':'Flag';
 $("#flagBtn").setAttribute('aria-pressed',meta[q.id].flagged?'true':'false');
 toast(meta[q.id].flagged?`Question ${index+1} flagged for review`:`Question ${index+1} unflagged`,2000);
 renderCrumbs();
}

function mount(){
 const q=bank[index];meta[q.id]=meta[q.id]||{flagged:false};
 $("#flagBtn").textContent=meta[q.id].flagged?'Unflag':'Flag';
 $("#flagBtn").setAttribute('aria-pressed',meta[q.id].flagged?'true':'false');

 renderCrumbs();
 const s=$("#stage");s.innerHTML='';
 const card=el('div','card');
 const titleLine = q.title + (q.tag ? ' — [' + q.tag + ']' : '');
 card.append(el('div','title', titleLine), el('div','hint', q.hint || ''));
 card.setAttribute('role','region');card.setAttribute('aria-label',q.title)

 if(q.type==='drag-classify'){
   const grid=el('div','grid col-12');
   const left=el('div','col-4');left.append(el('div','hint','Items'));const bucket=el('div','dropzone');left.append(bucket);grid.append(left);
   const right=el('div','col-8');const zones=el('div','grid');
   q.zones.forEach(z=>{const col=el('div','col-6');col.append(el('div','hint',z.title));const dz=el('div','dropzone');dz.dataset.zone=z.id;col.append(dz);zones.append(col)});
   right.append(zones);grid.append(right);card.append(grid);
   const st=state[q.id]=state[q.id]||{placed:{}};shuffle(q.items).forEach(it=>{const t=tile(it);const zone=st.placed[it.id];const target=zone?card.querySelector(`[data-zone="${zone}"]`):bucket;(target||bucket).append(t)})
 }

 if(q.type==='order'){
   const list=el('div','list');
   if(q.id==='staff'){ list.classList.add('pyramid-list'); }
   const st=state[q.id]=state[q.id]||{order:shuffle(q.items.map(i=>i.id))};
   st.order.forEach(id=>{const it=q.items.find(x=>x.id===id);const t=orderTile(it);if(q.id==='staff'){t.classList.add('pyr');}list.append(t)});
   card.append(list);
   enableSortable(list,q)
 }

 if(q.type==='single'||q.type==='multi'){
   card.append(el('div','hint',q.question));
   const box=el('div','choices');const st=state[q.id]=state[q.id]||{};
   q.choices.forEach(c=>{
     const ch=el('div','choice',c.text);
     if(q.type==='single'){
       ch.setAttribute('role','radio');ch.setAttribute('aria-checked',st.answer===c.id?'true':'false');
       ch.onclick=()=>{st.answer=c.id;mount()}
     }else{
       const on=(st.answers||[]).includes(c.id);
       ch.setAttribute('role','checkbox');ch.setAttribute('aria-checked',on?'true':'false');
       ch.onclick=()=>{const S=new Set(st.answers||[]);on?S.delete(c.id):S.add(c.id);st.answers=[...S];mount()}
     }
     box.append(ch)
   });
   card.append(box)
 }

 if(q.type==='match'){
   const grid=el('div','grid col-12');
   const left=el('div','col-6');const right=el('div','col-6');
   left.append(el('div','hint','Items (drag these)'));const bucket=el('div','dropzone');left.append(bucket);
   const st=state[q.id]=state[q.id]||{map:{}};
   shuffle(q.left).forEach(it=>{if(!st.map[it.id])bucket.append(tile(it))});
   q.right.forEach(cat=>{const row=el('div','row');row.append(el('div','hint',cat.title));const dz=el('div','dropzone');dz.dataset.cat=cat.id;
     Object.entries(st.map).forEach(([iid,cid])=>{if(cid===cat.id){const item=q.left.find(x=>x.id===iid);if(item)dz.append(tile(item))}});
     row.append(dz);right.append(row)
   });
   grid.append(left,right);card.append(grid)
 }

 if(q.type==='table'){
   const grid=el('div','grid col-12');
   const left=el('div','col-4');left.append(el('div','hint','Items'));const bucket=el('div','dropzone');left.append(bucket);grid.append(left);
   const right=el('div','col-8');
   const table=el('table','table');
   const header=document.createElement('tr');header.append(document.createElement('th'));
   q.columns.forEach(c=>{const th=document.createElement('th');th.textContent=c.title;header.append(th)});table.append(header);
   q.rows.forEach(r=>{const tr=document.createElement('tr');const th=document.createElement('th');th.textContent=r.title;tr.append(th);
     q.columns.forEach(c=>{const td=document.createElement('td');td.className='cell';td.dataset.cell=c.id;tr.append(td)});table.append(tr)
   });
   right.append(table);grid.append(right);card.append(grid);
   const st=state[q.id]=state[q.id]||{cells:{}};q.items.forEach(it=>{const t=tile(it);const cell=st.cells[it.id];const target=cell?card.querySelector(`[data-cell="${cell}"]`):bucket;(target||bucket).append(t)})
 }

 if(q.type==='phishRows'){
   const st=state[q.id]=state[q.id]||{};
   const container=el('div','grid col-12');
   const rowsCol=el('div','col-6');rowsCol.append(el('div','hint','Phishing + [method] = [result]'));
   const rows=document.createElement('div');rows.style.display='flex';rows.style.flexDirection='column';rows.style.gap='18px';
   for(let r=1;r<=3;r++){
     const row=document.createElement('div');row.style.display='flex';row.style.alignItems='center';row.style.gap='12px';
     const label=el('div','', 'Phishing +');label.style.fontWeight='800';label.style.color='var(--accent)';
     const plus=el('div','dropzone');plus.dataset.plus='plus'+r;plus.style.width='140px';plus.style.minHeight='64px';
     const eq=el('div','dropzone');eq.dataset.eq='eq'+r;eq.style.width='240px';eq.style.minHeight='64px';
     if(st['plus'+r+'_obj'])plus.append(tile(st['plus'+r+'_obj']));if(st['eq'+r+'_obj'])eq.append(tile(st['eq'+r+'_obj']));
     row.append(label,plus,el('div',null,'='),eq);rows.append(row)
   }
   rowsCol.append(rows);
   const resCol=el('div','col-3');resCol.append(el('div','hint','Pool'));const rpool=el('div','dropzone');rpool.dataset.pool='pool';resCol.append(rpool);
   const used=new Set();for(let i=1;i<=3;i++){if(st['plus'+i+'_id'])used.add(st['plus'+i+'_id']);if(st['eq'+i+'_id'])used.add(st['eq'+i+'_id'])}
   bank.find(b=>b.id==='phish').icons.forEach(ic=>{if(!used.has(ic.id)){const t=tile(ic);t.dataset.kind='icon';t.dataset.value=ic.value;rpool.append(t)}});
   bank.find(b=>b.id==='phish').results.forEach(r=>{if(!used.has('res_'+r.id)){const t=el('div','tile',r.text);t.draggable=true;t.dataset.kind='result';t.dataset.value=r.value;t.dataset.id='res_'+r.id;rpool.append(t)}});
   container.append(rowsCol,resCol);card.append(container)
 }

 if(q.type==='hotspot'){
   const st=state[q.id]=state[q.id]||{sel:{}};
   const wrap=el('div','');
   const holder=el('div','hotimg');
   const img=new Image(); img.src=q.image; img.alt='Company floor plan'; img.onload=()=>{};
   holder.append(img);

   (q.spots||[]).forEach((sp,i)=>{
     const dot=el('div','hotspot', String(i+1));
     dot.style.left = `calc(${sp.x}% - 14px)`;
     dot.style.top  = `calc(${sp.y}% - 14px)`;
     if(st.sel[sp.id]) dot.classList.add('answered');

     const label=el('div','hotlabel', sp.label || '');
     label.style.left = `calc(${sp.x}% )`;
     label.style.top  = `calc(${sp.y}% )`;

     const pop=el('div','hotpop');
     pop.innerHTML = `<div class="hint">Choose the control type</div>`;
     const row=el('div','hotopt');
     const opts=[
       {k:'managerial',label:'Managerial'},
       {k:'operational',label:'Operational'},
       {k:'technical',label:'Technical'},
       {k:'physical',label:'Physical'}
     ];
     opts.forEach(op=>{
       const b=el('button','btn',op.label);
       b.setAttribute('data-val', op.k);
       if(st.sel[sp.id]===op.k){ b.classList.add('btn--primary'); }
       b.onclick=(ev)=>{
         st.sel[sp.id]=op.k;
         dot.classList.add('answered');
         pop.style.display='none';
         ev.stopPropagation();
       };
       row.append(b);
     });
     const clr=el('button','btn','Clear');
     clr.onclick=(ev)=>{ delete st.sel[sp.id]; dot.classList.remove('answered'); pop.style.display='none'; ev.stopPropagation(); };
     row.append(clr);
     pop.append(row);
     holder.append(dot);
     holder.append(label);
     holder.append(pop);

     dot.onclick=(ev)=>{
       pop.style.left = `calc(${sp.x}% + 18px)`;
       pop.style.top  = `calc(${sp.y}% - 10px)`;
       pop.style.display = (pop.style.display==='block'?'none':'block');
       ev.stopPropagation();
     };
   });

   holder.addEventListener('click', ()=>{
     holder.querySelectorAll('.hotpop').forEach(p=>p.style.display='none');
   });

   wrap.append(holder);
   wrap.append(el('div','hot-legend', 'Tip: Click a marker, then pick a category. You can change your choice later.'));
   card.append(wrap);
 }

 $("#stage").append(card);
 wireDnD(q);
 enableKeyboardPick()
}

function enableSortable(list,q){
 list.addEventListener('dragstart',e=>{if(e.target.classList.contains('tile'))e.target.classList.add('dragging')})
 list.addEventListener('dragover',e=>{
   e.preventDefault();
   const dragging=list.querySelector('.tile.dragging');
   if(!dragging)return;
   const els=[...list.querySelectorAll('.tile:not(.dragging)')];
   const after=els.reduce((c,ch)=>{const b=ch.getBoundingClientRect();const off=e.clientY-b.top-b.height/2;return(off<0&&off>c.off)?{off,el:ch}:c},{off:-Infinity,el:null}).el;
   after?list.insertBefore(dragging,after):list.append(dragging)
 })
 list.addEventListener('drop',()=>{
   const ids=[...list.querySelectorAll('.tile')].map(n=>n.dataset.id);
   const st=state[bank[index].id]=state[bank[index].id]||{};st.order=ids;
   document.querySelectorAll('.tile').forEach(t=>t.classList.remove('dragging'))
 })
 list.addEventListener('dragend',()=>document.querySelectorAll('.tile').forEach(t=>t.classList.remove('dragging')))
}

function wireDnD(q){
 document.querySelectorAll('.tile').forEach(t=>{t.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',t.dataset.id)})})
 document.querySelectorAll('.dropzone,.cell').forEach(z=>{
  z.addEventListener('dragover',e=>e.preventDefault())
  z.addEventListener('drop',e=>{e.preventDefault();const id=e.dataTransfer.getData('text/plain');place(q,z,id)})
  z.addEventListener('click',()=>{if(selectedTile){place(q,z,selectedTile.dataset.id);selectedTile=null}})
 })
}

function place(q,z,id){
 const node=document.querySelector(`.tile[data-id="${id}"]`);if(!node)return
 if(q.id==='phish'){
  z.append(node);
  const st=state[q.id]=state[q.id]||{};
  if(z.dataset.plus){
    st[z.dataset.plus+'_id']=id;
    st[z.dataset.plus+'_obj']={id:node.dataset.id,text:node.textContent,html:node.innerHTML,value:node.dataset.value};
  } else if(z.dataset.eq){
    st[z.dataset.eq+'_id']=id;
    st[z.dataset.eq+'_obj']={id:node.dataset.id,text:node.textContent,html:node.innerHTML,value:node.dataset.value};
  } else {
    for(let r=1;r<=3;r++){
      if(st['plus'+r+'_id']===id){ delete st['plus'+r+'_id']; delete st['plus'+r+'_obj']; }
      if(st['eq'+r+'_id']===id){ delete st['eq'+r+'_id']; delete st['eq'+r+'_obj']; }
    }
  }
  return
 }
 z.append(node);
 const st=state[q.id]=state[q.id]||{}
 if(q.type==='drag-classify'){st.placed=st.placed||{};const zone=z.dataset.zone||null;if(zone){st.placed[id]=zone}else{delete st.placed[id]}}
 if(q.type==='match'){st.map=st.map||{};const cat=z.dataset.cat||null;if(cat){st.map[id]=cat}else{delete st.map[id]}}
 if(q.type==='table'){st.cells=st.cells||{};const cell=z.dataset.cell||null;if(cell){st.cells[id]=cell}else{delete st.cells[id]}}
}

function finishExam(){
 for(const q of bank){
  const st=state[q.id]||{};let isAnswered=false
  if(q.type==='drag-classify'){isAnswered=st.placed&&Object.keys(st.placed).length>0}
  else if(q.type==='order'){isAnswered=st.order&&st.order.length>0}
  else if(q.type==='single'){isAnswered=!!st.answer}
  else if(q.type==='multi'){isAnswered=st.answers&&st.answers.length>0}
  else if(q.type==='match'){isAnswered=st.map&&Object.keys(st.map).length>0}
  else if(q.type==='table'){isAnswered=st.cells&&Object.keys(st.cells).length>0}
  else if(q.type==='phishRows'){for(let r=1;r<=3;r++){if(st['plus'+r+'_id']||st['eq'+r+'_id']){isAnswered=true;break}}}
  else if(q.type==='hotspot'){isAnswered = st.sel && Object.keys(st.sel).length>0}
  if(!isAnswered){toast(`Please answer all questions before finishing the exam.`,3000);return}
 }
 const {got,total}=scoreAll();lastGot=got;lastTotal=total;lastPct=total?Math.round((got/total)*100):0
 buildReport()
 if(lastPct<75){toast(`You must score 75% or higher to generate a certificate. Your score: ${lastPct}%.`,3000);return}
 $("#nameGate").style.display='block'
 $("#studentName").focus()
}

function openCertificate(){
 const name=$("#studentName").value?.trim();if(!name){toast('Please enter your name.');return}
 if(typeof lastPct==='undefined'||lastPct===null){const res=scoreAll();lastGot=res.got;lastTotal=res.total;lastPct=res.total?Math.round((res.got/res.total)*100):0;buildReport()}
 if(lastPct<75){toast('Certificate generation is only available for scores of 75% or higher.',3000);return}
 $("#certName").textContent=name
 $("#certDate").textContent=todayStr()
 $("#passFlag").textContent='PASS'
 $("#certScore").textContent=`Score: ${lastPct}% • PASS`
 $("#nameGate").style.display='none'
 const wrap=$("#certWrap");wrap.style.display='block';wrap.scrollIntoView({behavior:'smooth',block:'start'})
}

function closeCert(){ $("#certWrap").style.display='none' }
function printCert(){
 const cert=$("#cert"); const btnRow=$("#certWrap .btnrow"); if(btnRow)btnRow.style.display='none';
 html2canvas(cert,{backgroundColor:null,scale:2}).then(canvas=>{
  if(btnRow)btnRow.style.display='flex';
  const link=document.createElement('a'); link.href=canvas.toDataURL('image/png'); link.download='certificate.png'; link.click();
 }).catch(()=>{toast('Failed to generate image. Try again.'); if(btnRow)btnRow.style.display='flex';});
}

// Warning overlay controls
function showWarn(){ const g=$("#warnGate"); if(!g) return; g.style.display='flex'; document.body.style.overflow='hidden'; }
function hideWarn(){ const g=$("#warnGate"); if(!g) return; g.style.display='none'; document.body.style.overflow=''; }
$("#warnContinue").onclick=hideWarn;
$("#warnHideForever").onclick=()=>{ try{ localStorage.setItem('PBQ_WARN_ACK','1'); }catch(e){} hideWarn(); };

// Theme toggle: switch attribute, button label, and logo
$("#themeBtn").onclick=()=>{
  const cur=document.documentElement.getAttribute('data-theme')||'dark';
  const next = cur==='dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  $("#themeBtn").textContent=cur==='dark'?'🌞 Theme':'🌓 Theme';
  applyThemeAssets(); // << ensure logo swaps
};

$("#next").onclick=()=>{index=(index+1)%bank.length;mount()}
$("#prev").onclick=()=>{index=(index-1+bank.length)%bank.length;mount()}
$("#flagBtn").onclick=toggleFlag
$("#resetAll").onclick=()=>{if(confirm('Reset all progress?')){for(const k in state)delete state[k];for(const k in meta)delete meta[k];index=0;mount();$("#reportWrap").style.display='none';$("#certWrap").style.display='none';$("#nameGate").style.display='none'}}
$("#finishBtn").onclick=finishExam
$("#buildCert").onclick=openCertificate
$("#closeGate").onclick=()=>{$("#nameGate").style.display='none'}
$("#printCert").onclick=printCert
$("#closeCert").onclick=closeCert

// Boot
function boot(){
  try{
    const ack = localStorage.getItem('PBQ_WARN_ACK');
    if(ack!=='1') showWarn();
  }catch(e){
    showWarn();
  }
  applyThemeAssets(); // set correct logo for initial theme
  init();
}
function init(){mount();enableKeyboardPick()}
function enableKeyboardPick(){document.querySelectorAll('.tile').forEach(t=>{t.tabIndex=0;t.addEventListener('keydown',e=>{if(e.key==='Enter'){selectedTile=t;toast('Tile selected. Click a dropzone to place.')}})})}

window.addEventListener('load', boot);
</script>
</body>
</html>
